<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e293b, #0c4a6e, #164e63);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
        }

        .font-inter {
            font-family: 'Inter', sans-serif;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .nav-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            border-color: rgba(56, 189, 248, 0.3);
        }

        .admin-input {
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(255, 255, 255, 0.12);
            transition: all 0.3s ease;
        }

        .admin-input:focus {
            border-color: rgba(56, 189, 248, 0.5);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="flex flex-col min-h-screen px-4 py-8 relative">
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute bg-sky-500/10 w-80 h-80 -top-20 -right-20 blur-3xl rounded-full"></div>
        <div class="absolute bg-purple-500/10 w-64 h-64 bottom-0 -left-20 blur-3xl rounded-full"></div>
    </div>

    <div class="max-w-5xl w-full mx-auto relative z-10 flex-grow">

        <!-- Header -->
        <div class="flex items-center justify-between mb-8 slide-up">
            <div class="flex items-center gap-3">
                <a href="/"
                    class="glass-card px-4 py-2 rounded-xl text-white/70 hover:text-white text-sm flex items-center gap-2 transition font-inter">â†
                    Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <button onclick="logout()"
                    class="glass-card px-4 py-2 rounded-xl text-red-400 hover:text-red-300 text-sm flex items-center gap-2 transition font-inter hover:bg-red-500/10">ğŸšª
                    Ø®Ø±ÙˆØ¬</button>
            </div>
            <div class="text-right">
                <h1 class="text-2xl md:text-3xl font-black text-white">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
                <p class="text-gray-400 text-xs font-inter">Dashboard Admin</p>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 slide-up">
            <div class="stat-card glass-card rounded-2xl p-5 text-center">
                <div class="text-3xl mb-2">ğŸ‘¥</div>
                <p id="statElecteurs" class="text-2xl font-black text-white font-inter">0</p>
                <p class="text-gray-400 text-xs font-inter font-bold uppercase tracking-wider">Ù†Ø§Ø®Ø¨ÙŠÙ†</p>
            </div>
            <div class="stat-card glass-card rounded-2xl p-5 text-center">
                <div class="text-3xl mb-2">ğŸ—³ï¸</div>
                <p id="statVotes" class="text-2xl font-black text-sky-400 font-inter">0</p>
                <p class="text-gray-400 text-xs font-inter font-bold uppercase tracking-wider">Ø£ØµÙˆØ§Øª</p>
            </div>
            <div class="stat-card glass-card rounded-2xl p-5 text-center">
                <div class="text-3xl mb-2">ğŸ“Š</div>
                <p id="statTaux" class="text-2xl font-black text-amber-400 font-inter">0%</p>
                <p class="text-gray-400 text-xs font-inter font-bold uppercase tracking-wider">Ù…Ø´Ø§Ø±ÙƒØ©</p>
            </div>
            <div class="stat-card glass-card rounded-2xl p-5 text-center">
                <div class="text-3xl mb-2">ğŸ›ï¸</div>
                <p id="statListes" class="text-2xl font-black text-purple-400 font-inter">0</p>
                <p class="text-gray-400 text-xs font-inter font-bold uppercase tracking-wider">Ù„ÙˆØ§Ø¦Ø­</p>
            </div>
        </div>

        <!-- Toggle Vote + Settings -->
        <div class="grid md:grid-cols-2 gap-6 mb-8 slide-up">
            <!-- Vote Toggle -->
            <div class="glass-card rounded-3xl p-6">
                <h2 class="text-lg font-extrabold text-white mb-5 border-b border-white/10 pb-3">ğŸ”’ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª</h2>
                <div class="flex items-center justify-between">
                    <div>
                        <p id="voteStatusText" class="text-white font-bold">Ø§Ù„ØªØµÙˆÙŠØª Ù…ÙØªÙˆØ­</p>
                        <p class="text-gray-500 text-xs font-inter">Cliquez pour changer</p>
                    </div>
                    <button onclick="toggleVote()" id="voteToggleBtn"
                        class="px-6 py-3 rounded-2xl font-bold text-sm transition-all shadow-lg">
                        ğŸ”“ Ù…ÙØªÙˆØ­
                    </button>
                </div>
            </div>

            <!-- Upload Logo -->
            <div class="glass-card rounded-3xl p-6">
                <h2 class="text-lg font-extrabold text-white mb-5 border-b border-white/10 pb-3">ğŸ–¼ï¸ Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©</h2>
                <div class="flex items-center gap-4">
                    <div id="logoPreview"
                        class="w-16 h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center overflow-hidden flex-shrink-0">
                        <span class="text-2xl">ğŸ—³ï¸</span>
                    </div>
                    <div class="flex-grow">
                        <input type="file" id="logoFile" accept="image/*" class="hidden" onchange="uploadLogo()">
                        <button onclick="document.getElementById('logoFile').click()"
                            class="w-full py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-white font-bold text-sm transition">
                            ğŸ“¤ ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Cards -->
        <div class="grid md:grid-cols-2 gap-6 mb-8 slide-up">
            <a href="/gestion-listes.html" class="nav-card glass-card rounded-3xl p-8 text-center group">
                <div class="text-5xl mb-4 group-hover:scale-110 transition-transform">ğŸ›ï¸</div>
                <h3 class="text-xl font-black text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ÙˆØ§Ø¦Ø­ ÙˆØ§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ†</h3>
                <p class="text-gray-400 text-sm font-inter">GÃ©rer les listes et candidats</p>
            </a>
            <a href="/resultats.html" class="nav-card glass-card rounded-3xl p-8 text-center group">
                <div class="text-5xl mb-4 group-hover:scale-110 transition-transform">ğŸ“Š</div>
                <h3 class="text-xl font-black text-white mb-2">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
                <p class="text-gray-400 text-sm font-inter">RÃ©sultats en direct</p>
            </a>
            <a href="/pv-generator.html"
                class="glass-card px-6 py-3 rounded-xl text-white font-bold flex items-center gap-2 hover:bg-white/10 transition">
                ğŸ“‹ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¶Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ â€” GÃ©nÃ©rer le PV
            </a>
        </div>

        <!-- Electeurs Table  -->
        <div class="glass-card rounded-3xl p-6 md:p-8 slide-up">
            <h2 class="text-xl font-extrabold text-white mb-6 border-b border-white/10 pb-4">
                ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ†
                <span class="block text-sm font-inter text-gray-400 font-medium mt-1">Liste des Ã©lecteurs (lecture
                    seule)</span>
            </h2>
            <div class="mb-4">
                <input type="text" id="searchElecteur" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..."
                    class="admin-input w-full px-5 py-3 rounded-xl text-white outline-none text-right text-sm"
                    oninput="filterElecteurs()">
            </div>
            <div class="overflow-x-auto rounded-xl border border-white/10">
                <table class="w-full text-sm" dir="rtl">
                    <thead>
                        <tr class="bg-white/5 border-b border-white/10">
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-400 uppercase font-inter">#</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-400 uppercase font-inter">Ø§Ù„Ø§Ø³Ù…
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-400 uppercase font-inter">Ø§Ù„Ù‡Ø§ØªÙ
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-400 uppercase font-inter">Ø§Ù„Ø­Ø§Ù„Ø©
                            </th>
                        </tr>
                    </thead>
                    <tbody id="electeursBody" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="text-center py-6 relative z-10 mt-8">
        <p class="text-gray-600 text-xs font-inter">Â© 2026 â€” Admin Ã‰lections Marrakech</p>
    </footer>

    <script>
        let allElecteurs = [];

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();
                document.getElementById('statElecteurs').textContent = data.total_electeurs;
                document.getElementById('statVotes').textContent = data.total_votes;
                document.getElementById('statTaux').textContent = data.taux_participation + '%';
                document.getElementById('statListes').textContent = data.total_listes;
            } catch (e) { console.error(e); }
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                updateVoteToggle(data.vote_ouvert);
                if (data.logo_url) {
                    document.getElementById('logoPreview').innerHTML = `<img src="${data.logo_url}" class="w-full h-full object-cover rounded-2xl">`;
                }
            } catch (e) { console.error(e); }
        }

        function updateVoteToggle(isOpen) {
            const btn = document.getElementById('voteToggleBtn');
            const text = document.getElementById('voteStatusText');
            if (isOpen) {
                btn.className = 'px-6 py-3 rounded-2xl font-bold text-sm transition-all shadow-lg bg-green-500/20 text-green-400 border border-green-500/30 hover:bg-green-500/30';
                btn.textContent = 'ğŸ”“ Ù…ÙØªÙˆØ­';
                text.textContent = 'Ø§Ù„ØªØµÙˆÙŠØª Ù…ÙØªÙˆØ­';
                text.className = 'text-green-400 font-bold';
            } else {
                btn.className = 'px-6 py-3 rounded-2xl font-bold text-sm transition-all shadow-lg bg-red-500/20 text-red-400 border border-red-500/30 hover:bg-red-500/30';
                btn.textContent = 'ğŸ”’ Ù…ØºÙ„Ù‚';
                text.textContent = 'Ø§Ù„ØªØµÙˆÙŠØª Ù…ØºÙ„Ù‚';
                text.className = 'text-red-400 font-bold';
            }
        }

        async function toggleVote() {
            try {
                const res = await fetch('/api/admin/toggle-vote', { method: 'POST' });
                const data = await res.json();
                if (data.success) updateVoteToggle(data.vote_ouvert);
            } catch (e) { console.error(e); }
        }

        async function uploadLogo() {
            const file = document.getElementById('logoFile').files[0];
            if (!file) return;
            const form = new FormData();
            form.append('logo', file);
            form.append('titre', 'Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª ÙØ±Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø·Ø© ÙÙŠ Ù…Ø±Ø§ÙƒØ´ 2026/2027');
            form.append('vote_ouvert', '1');
            try {
                const res = await fetch('/api/admin/settings', { method: 'POST', body: form });
                const data = await res.json();
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', timer: 1500, showConfirmButton: false });
                    loadSettings();
                }
            } catch (e) { Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£' }); }
        }

        async function loadElecteurs() {
            try {
                const res = await fetch('/api/admin/electeurs');
                allElecteurs = await res.json();
                renderElecteurs(allElecteurs);
            } catch (e) { console.error(e); }
        }

        function renderElecteurs(data) {
            const tbody = document.getElementById('electeursBody');
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø§Ø®Ø¨ÙŠÙ†</td></tr>';
                return;
            }
            tbody.innerHTML = data.map((e, i) => `
                <tr class="hover:bg-white/5 transition">
                    <td class="px-4 py-3 text-gray-500 font-inter text-xs">${i + 1}</td>
                    <td class="px-4 py-3 text-white font-bold text-sm">${e.nom}</td>
                    <td class="px-4 py-3 text-gray-300 font-inter text-sm" dir="ltr">${e.telephone}</td>
                    <td class="px-4 py-3">
                        ${e.has_voted
                    ? `<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold bg-green-500/20 text-green-400 border border-green-500/20">âœ… ØµÙˆÙ‘Øª</span>`
                    : `<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold bg-gray-500/20 text-gray-400 border border-gray-500/20">â³ Ù„Ù… ÙŠØµÙˆØª</span>`
                }
                    </td>
                </tr>
            `).join('');
        }

        function filterElecteurs() {
            const term = document.getElementById('searchElecteur').value.toLowerCase();
            const filtered = allElecteurs.filter(e => e.nom.toLowerCase().includes(term) || e.telephone.includes(term));
            renderElecteurs(filtered);
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        loadStats();
        loadSettings();
        loadElecteurs();
    </script>
</body>

</html>